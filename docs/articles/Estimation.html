<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Naive-Pooled Parameter Estimation • ubiquity</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Naive-Pooled Parameter Estimation">
<meta property="og:description" content="ubiquity">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ubiquity</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-chalkboard-teacher"></span>
     
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    <li class="dropdown-header">Getting Started</li>
    <li>
      <a href="../articles/Simulation.html">Individual and Population Simulations</a>
    </li>
    <li>
      <a href="../articles/Language.html">ubiquity Modeling Language</a>
    </li>
    <li>
      <a href="../articles/Estimation.html">Naive-Pooled Parameter Estimation</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Other Analysis Options</li>
    <li>
      <a href="../articles/Deployment.html">Deploying Your Models in a Shiny App</a>
    </li>
    <li>
      <a href="../articles/Titration.html">Trial/Rule-Based Simulations</a>
    </li>
    <li>
      <a href="../articles/NCA.html">Non-Compartmental Analysis</a>
    </li>
    <li>
      <a href="../articles/Reporting.html">Integrated Word and PowerPoint Reporting</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-video"></span>
     
    Screencasts
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://vimeo.com/382859445" class="external-link">Individual and Population Simulations</a>
    </li>
    <li>
      <a href="https://vimeo.com/382860283" class="external-link">Model Deployment</a>
    </li>
    <li>
      <a href="https://vimeo.com/manage/videos/382829588" class="external-link">Naive-Pooled Parameter Estimation</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fas fa-hat-wizard"></span>
     
    Functions
  </a>
</li>
<li>
  <a href="../news/index.html">
    <span class="fas fa-rss"></span>
     
    News
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/john-harrold/ubiquity/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Estimation_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Naive-Pooled Parameter Estimation</h1>
                        <h4 data-toc-skip class="author">John Harrold &amp; Anson Abraham</h4>
            
            <h4 data-toc-skip class="date">2021-08-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/john-harrold/ubiquity/blob/master/vignettes/Estimation.Rmd" class="external-link"><code>vignettes/Estimation.Rmd</code></a></small>
      <div class="hidden name"><code>Estimation.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor" aria-hidden="true"></a>Introduction <img src="ubiquity_hex.png" align="right" height="138.5" border="0px">
</h2>
<p>The workshop (<a href="https://ubiquity-pkpd.s3-us-west-1.amazonaws.com/files/ubiquity_workshop.zip" class="external-link">workshop.ubiquity.tools</a>) provides several examples of performing parameter estimation in ubiquity. To make a copy of these scripts and other supporting files in the current working directory run the following:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ubiquity.tools/rworkflow" class="external-link">ubiquity</a></span><span class="op">)</span>
<span class="va">fr</span> <span class="op">=</span> <span class="fu"><a href="../reference/workshop_fetch.html">workshop_fetch</a></span><span class="op">(</span>section<span class="op">=</span><span class="st">"Estimation"</span>, overwrite<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<ul>
<li>
<code>analysis_parent.r</code> - Least squares estimation of a single output</li>
<li>
<code>analysis_parent_metabolite.r</code> - Maximum likelihood estimation of two outputs</li>
<li>
<code>analysis_parent_metabolite_global.r</code> - Using global optimization packages<br>
</li>
<li>
<code>analysis_parent_metabolite_nm_data.r</code> - Reading cohorts in from a NONMEM file</li>
</ul>
<p>Each of these scripts build on the previous one to demonstrate different features of the ubiquity parameter estimation routines. All of these examples use a system (shown in the figure below) that contains three differential equations tracking the mass of the parent drug in the blood (<code>Mpb</code>) and in a tissue space (<code>Mpt</code>). In the blood the parent can form (<code>fmKp</code>) a metabolite (<code>Mmb</code>) with subsequent elimination (<code>Km</code>). The parent/metabolite model was adapted from the ADAPT5 Users Manual (<a href="https://bmsr.usc.edu/files/2013/02/ADAPT5-User-Guide.pdf" class="external-link uri">https://bmsr.usc.edu/files/2013/02/ADAPT5-User-Guide.pdf</a>).</p>
<div class="figure">
<img src="system-estimation_example.png" width="450" alt=""><p class="caption">Model structure of parent/metabolite model</p>
</div>
<p>Using <code>system_new</code> (use <code><a href="../reference/system_new.html">?system_new</a></code> to see a list of the available system file examples) you can copy this template file into the current directory and build the system:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ubiquity.tools/rworkflow" class="external-link">ubiquity</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/system_new.html">system_new</a></span><span class="op">(</span>file_name<span class="op">=</span><span class="st">"system.txt"</span>, system_file<span class="op">=</span><span class="st">"adapt"</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/build_system.html">build_system</a></span><span class="op">(</span>system_file <span class="op">=</span> <span class="st">"system.txt"</span><span class="op">)</span></code></pre></div>
<p>Once the system has been built, you can create a local copy of an estimation template for the system:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/system_fetch_template.html">system_fetch_template</a></span><span class="op">(</span><span class="va">cfg</span>, template<span class="op">=</span><span class="st">"Estimation"</span><span class="op">)</span></code></pre></div>
<p>This should create the file: <code>analysis_estimate.R</code> in the working directory. At the beginning of the script there are three variables that are created to control what the script does and the format of the output. The variable <code>analysis_name</code> defines the prefix that will be prepended to the output generated by the script. Archiving the analysis results is controlled by the Boolean variable <code>archive_results</code>. Lastly, the script is controlled using the <code>flowctl</code> variable (the possible options are listed and commented out).</p>
<p>The estimation script has the following main components:</p>
<ol style="list-style-type: decimal">
<li>Select the parameter set and subset of parameters to estimate</li>
<li>Set options (simulation, estimation, etc)</li>
<li>Load datasets</li>
<li>Define cohorts</li>
<li>Estimate parameters</li>
<li>Plot results</li>
</ol>
<p>These will be explored using the scripts above.</p>
</div>
<div id="least-squares-estimationsingle-output-analysis_parent-r" class="section level2">
<h2 class="hasAnchor">
<a href="#least-squares-estimationsingle-output-analysis_parent-r" class="anchor" aria-hidden="true"></a>Least squares estimation/single output (<code>analysis_parent.r</code>)</h2>
<p>The first example above (<code>analysis_parent.r</code>) begins by specifying that we want to perform a parameter estimation and archive the results using the name<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> <code>parent_d1030</code> to indicate we are analyzing the parent PK for the 10 and 30 mg dosing cohorts:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">flowctl</span> <span class="op">=</span> <span class="st">'estimate'</span>
<span class="va">archive_results</span> <span class="op">=</span> <span class="cn">TRUE</span>
<span class="va">analysis_name</span> <span class="op">=</span> <span class="st">'parent_d1030'</span></code></pre></div>
<p>Next we select the parameters to estimate. Because we’re only estimating parent data, only the names of the parameters relevant to the parent PK (<code>pnames</code>) are selected. To estimate all parameters simply exclude the third argument. Because only system parameters are being estimated a weighted least squares objective will be used<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pnames</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Vp'</span>, <span class="st">'Vt'</span>, <span class="st">'CLp'</span>, <span class="st">'Q'</span><span class="op">)</span>
<span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_select_set.html">system_select_set</a></span><span class="op">(</span><span class="va">cfg</span>, <span class="st">"default"</span>, <span class="va">pnames</span><span class="op">)</span></code></pre></div>
<p>Next we set options relevant to the estimation and the underlying simulation routines. In this example only the simulation output times have been specified, but any relevant parameters can be set. The template that is generated has several common options that are commented out. These can be uncommented and modified as needed.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cfg</span><span class="op">=</span><span class="fu"><a href="../reference/system_set_option.html">system_set_option</a></span><span class="op">(</span><span class="va">cfg</span>, group  <span class="op">=</span> <span class="st">"simulation"</span>, 
                           option <span class="op">=</span> <span class="st">"output_times"</span>, 
                           <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The dataset (shown in the table below) is included with the <code>ubiquity</code> package and is accessed here using <code>system.file</code>. In the example script it is referenced explicitly. The format requirements of datasets is that they be flat files with a header row. The format is flexible and only requires time/observation information and columns required to filter the data and isolate cohorts that have received the same treatment. The inputs are defined when the cohorts themselves are defined. Data files are loaded using <code><a href="../reference/system_load_data.html">system_load_data()</a></code> and a name<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a> is assigned the dataset. Data can be read from files (csv, xls, xlsx, and tab) or from an existing data frame. This name (<code>pm_data</code> here) will be used to reference this dataset later in the script.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_load_data.html">system_load_data</a></span><span class="op">(</span><span class="va">cfg</span>, dsname     <span class="op">=</span> <span class="st">"pm_data"</span>, 
                            data_file  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"ubinc"</span>, <span class="st">"csv"</span>,
                                                     <span class="st">"pm_data.csv"</span>, 
                                                     package <span class="op">=</span> <span class="st">"ubiquity"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The dataset has a column for the observation time (<code>TIME</code>), the subject id (<code>ID</code>), concentrations for the parent (<code>PT</code>) and the metabolite (<code>MT</code>), a <code>BLQ</code> flag and the nominal dose (<code>DOSE</code>). But only some of these columns will be used (<code>TIME</code>, <code>PT</code>, <code>MT</code> and <code>DOSE</code>), and any others (<code>BQL</code>) will be ignored. This is intended to be an example and not a general guide for a dataset format. It is not necessary to have different outputs in different columns (wide format). The dataset could be loaded in the tall skinny format as well. In this example we are going to analyze the parent data for individuals given 10 or 30 mg using a least squares objective.</p>
<p>Next we need to identify the data and inputs associated with those data. This is done by defining <em>cohorts</em>, groups of data that receive the same treatment and the model inputs (bolus dosing, infusion rates, covariates) associated with those cohorts. In this example we will define a cohort for each dosing group. To make sure we are starting from a blank slate we can use <code><a href="../reference/system_clear_cohorts.html">system_clear_cohorts()</a></code> to remove any previously defined information.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_clear_cohorts.html">system_clear_cohorts</a></span><span class="op">(</span><span class="va">cfg</span><span class="op">)</span></code></pre></div>
<p>For each cohort we define a list with information about that cohort. Each cohort should have a unique <code>name</code> field<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a> and a <code>dataset</code> field pointing to the dataset (<code>pm_data</code>) loaded above. The optional cohort filter (<code>cf</code>) field is used to reduce the entire dataset to the records associated with this cohort. See the help for <code><a href="../reference/system_define_cohort.html">system_define_cohort()</a></code> for more information on how to construct cohort filters.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cohort</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
  name         <span class="op">=</span> <span class="st">"dose_10"</span>,
  cf           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>DOSE      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span>,
  inputs       <span class="op">=</span> <span class="cn">NULL</span>,
  outputs      <span class="op">=</span> <span class="cn">NULL</span>,
  dataset      <span class="op">=</span> <span class="st">"pm_data"</span><span class="op">)</span></code></pre></div>
<p>Next it is necessary to define the inputs for this cohort. Here inputs refers to model inputs which may include both dosing as well as covariates, and the estimation template (generated using <code><a href="../reference/system_fetch_template.html">system_fetch_template()</a></code> above) should contain placeholders for each of these defined in the system file. Note: For bolus and infusion inputs, it is only necessary to define inputs that are nonzero, and for covariates it is only necessary to define those that differ from the definitions in the system file. For each input there is an <code>AMT</code> field and <code>TIME</code> field and the units here are those specified in the system file (both <code>AMT</code> and <code>TIME</code> are internal indentifiers and not taken from the dataset).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cohort</span><span class="op">[[</span><span class="st">"inputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"bolus"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"inputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"bolus"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Mpb"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="cn">NULL</span>, AMT<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"inputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"bolus"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Mpb"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"TIME"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">0</span><span class="op">)</span> <span class="co"># hours </span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"inputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"bolus"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Mpb"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"AMT"</span><span class="op">]</span><span class="op">]</span>  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="co"># mpk </span></code></pre></div>
<p>Next we need to match the outputs in the model to the outputs in the dataset. Under <code>cohort$outputs</code> there is a field used to group each output. Here the cohort <strong>output mapping</strong> for the blood PK of the parent output is <code>Parent</code>. The times and observations in the dataset are found in the <code>'TIME’</code> column and the <code>’PT’</code> column (missing data specified by -1 will be dropped). These are mapped to the model timescale (<code>'hours'</code>, specified with <code>&lt;TS:?&gt;</code>) and model output (<code>’Cpblood’</code>, specified with <code>&lt;O&gt;</code>). Note the units in the dataset must be the same as those in the model:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Parent"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># Mapping to data set</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Parent"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"obs"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
         time           <span class="op">=</span> <span class="st">"TIME"</span>,
         value          <span class="op">=</span> <span class="st">"PT"</span>,
         missing        <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>

<span class="co"># Mapping to system file</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Parent"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"model"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
         time           <span class="op">=</span> <span class="st">"hours"</span>,       
         value          <span class="op">=</span> <span class="st">"Cpblood"</span>,   
         variance       <span class="op">=</span> <span class="st">"1"</span><span class="op">)</span>

<span class="co"># Plot formatting</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Parent"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"options"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
         marker_color   <span class="op">=</span> <span class="st">"black"</span>,
         marker_shape   <span class="op">=</span> <span class="fl">1</span>,
         marker_line    <span class="op">=</span> <span class="fl">2</span> <span class="op">)</span></code></pre></div>
<p>For each output grouping in the cohort the marker color, shape and line type can be specified (controlling the plotted output).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Parent"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"options"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
         marker_color   <span class="op">=</span> <span class="st">"black"</span>,
         marker_shape   <span class="op">=</span> <span class="fl">1</span>,
         marker_line    <span class="op">=</span> <span class="fl">2</span> <span class="op">)</span></code></pre></div>
<p>Finally the cohort is defined using <code><a href="../reference/system_define_cohort.html">system_define_cohort()</a></code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_define_cohort.html">system_define_cohort</a></span><span class="op">(</span><span class="va">cfg</span>, <span class="va">cohort</span><span class="op">)</span></code></pre></div>
<p>We do the same thing for the 30 mg dose group:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cohort</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
  name         <span class="op">=</span> <span class="st">"dose_30"</span>,
  cf           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>DOSE      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span><span class="op">)</span><span class="op">)</span>,
  dataset      <span class="op">=</span> <span class="st">"pm_data"</span>,
  inputs       <span class="op">=</span> <span class="cn">NULL</span>,
  outputs      <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>

<span class="co"># Bolus inputs for the cohort</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"inputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"bolus"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"inputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"bolus"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Mpb"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="cn">NULL</span>, AMT<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"inputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"bolus"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Mpb"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"TIME"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">0</span><span class="op">)</span> <span class="co"># hours </span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"inputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"bolus"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Mpb"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"AMT"</span><span class="op">]</span><span class="op">]</span>  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span><span class="op">)</span> <span class="co"># mpk </span>


<span class="co"># Defining Parent output</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Parent"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># Mapping to data set</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Parent"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"obs"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
         time           <span class="op">=</span> <span class="st">"TIME"</span>,
         value          <span class="op">=</span> <span class="st">"PT"</span>,
         missing        <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>

<span class="co"># Mapping to system file</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Parent"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"model"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
         time           <span class="op">=</span> <span class="st">"hours"</span>,       
         value          <span class="op">=</span> <span class="st">"Cpblood"</span>,   
         variance       <span class="op">=</span> <span class="st">"1"</span><span class="op">)</span>

<span class="co"># Plot formatting</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Parent"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"options"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
         marker_color   <span class="op">=</span> <span class="st">"red"</span>,
         marker_shape   <span class="op">=</span> <span class="fl">2</span>,
         marker_line    <span class="op">=</span> <span class="fl">2</span> <span class="op">)</span>
<span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_define_cohort.html">system_define_cohort</a></span><span class="op">(</span><span class="va">cfg</span>, <span class="va">cohort</span><span class="op">)</span></code></pre></div>
<p>After the cohorts have been defined we call the estimation function (<code><a href="../reference/system_estimate_parameters.html">system_estimate_parameters()</a></code>). If <code>flowctl</code> is set to <code>'plot previous estimate'</code> or <code>'plot guess'</code> the those values will just be returned.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pest</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_estimate_parameters.html">system_estimate_parameters</a></span><span class="op">(</span><span class="va">cfg</span>, 
                                  flowctl         <span class="op">=</span> <span class="va">flowctl</span>, 
                                  analysis_name   <span class="op">=</span> <span class="va">analysis_name</span>, 
                                  archive_results <span class="op">=</span> <span class="va">archive_results</span><span class="op">)</span></code></pre></div>
<p>If one of the estimation options are selected for the <code>flowctl</code> then several files will be generated in the <code>output</code> folder with the <code>analysis_name</code> as a prefix:</p>
<ul>
<li>
<code>output/parent_d1030-report.txt</code> - Text file with a summary of the estimation results.</li>
<li>
<code>output/parent_d1030-parameters_all.csv</code> - Summary table with all parameters (estimated and fixed)</li>
<li>
<code>output/parent_d1030-parameters_est.csv</code> - Summary table with estimated parameters</li>
<li>
<code>output/parent_d1030-system_update.txt</code> - Text to update the <code>system.txt</code> file with the new parameter estimates</li>
<li>
<code>output/parent_d1030-sessionInfo.RData</code> - The output of <code><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo()</a></code> is stored in the <code>SI</code> object in this data file</li>
</ul>
<p>Next the system is simulated at the estimate and the data is stored in <code>erp</code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cfg</span><span class="op">=</span><span class="fu"><a href="../reference/system_set_option.html">system_set_option</a></span><span class="op">(</span><span class="va">cfg</span>, group  <span class="op">=</span> <span class="st">"simulation"</span>, 
                           option <span class="op">=</span> <span class="st">"output_times"</span>, 
                           <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">erp</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_simulate_estimation_results.html">system_simulate_estimation_results</a></span><span class="op">(</span>pest <span class="op">=</span> <span class="va">pest</span>, cfg <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span> </code></pre></div>
<p>The information in this variable will be used to generate some standard plots below, but it may be desirable to save this information or generate your own figures. To do this it is necessary to understand the structure of <code>erp</code>. This list has two different fields.</p>
<ul>
<li>
<code>erp$pred</code> Data frame containing the time course data as well as the smooth predictions for all defined <code>OUTPUTS</code> for a given <code>COHORT</code>. The column <code>SMOOTH</code> is used to indicate what record type we’re dealing with. If the <code>SMOOTH</code> column is <code>FALSE</code> then <code>OBS</code> contains the observations and <code>VAR</code> contains the variance. If <code>SMOOTH</code> is <code>TRUE</code> then <code>OBS</code> and <code>VAR</code> will contain <code>-1</code>.
<ul>
<li>
<code>TIME</code> - Time in units of the data</li>
<li>
<code>OBS</code> - Observations (<code>SMOOTH = FALSE</code>), -1 (<code>SMOOTH=TRUE</code>)</li>
<li>
<code>PRED</code> - Predictions (<code>SMOOTH = FALSE</code>)</li>
<li>
<code>VAR</code> - Variance (<code>SMOOTH = FALSE</code>), -1 (<code>SMOOTH=TRUE</code>)</li>
<li>
<code>SMOOTH</code> - <code>FALSE</code> for observation times, <code>TRUE</code> for observations</li>
<li>
<code>OUTPUT</code> - name of the output</li>
<li>
<code>COHORT</code> - name of the cohort</li>
</ul>
</li>
<li>
<code>erp$all</code> List with model predictions for each output and state are generated for each cohort at the specified simulation times.
<ul>
<li>
<code>ts.time</code> - Simulation time scale</li>
<li>
<code>ts.TS</code> - An entry for each timescale <code>TS</code>
</li>
<li>
<code>pred</code> - Simulated predictions</li>
<li>
<code>name</code> - State or model output</li>
<li>
<code>cohort</code> - Cohort name</li>
</ul>
</li>
</ul>
<p>Lastly the predictions overlaying the data and the observed vs predicted plots are generated using <code><a href="../reference/system_plot_cohorts.html">system_plot_cohorts()</a></code>. Basic formatting of these figures is controlled using the <code>plot_opts</code> list (see the <code><a href="../reference/system_plot_cohorts.html">?system_plot_cohorts</a></code> for details).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plot_opts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">plot_opts</span><span class="op">$</span><span class="va">outputs</span><span class="op">$</span><span class="va">Parent</span><span class="op">$</span><span class="va">yscale</span>       <span class="op">=</span> <span class="st">'log'</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plinfo</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_plot_cohorts.html">system_plot_cohorts</a></span><span class="op">(</span><span class="va">erp</span>, <span class="va">plot_opts</span>, <span class="va">cfg</span>, analysis_name<span class="op">=</span><span class="va">analysis_name</span><span class="op">)</span></code></pre></div>
<p>When called, <code><a href="../reference/system_plot_cohorts.html">system_plot_cohorts()</a></code> will write <code>png</code> and <code>pdf</code> output for the time course and observed vs predicted files. It will also return a list with the <code>ggplot</code> objects and relative paths to the files as well. In this example the following will be generated:</p>
<ul>
<li>output/parent_d1030_time course_Parent.pdf</li>
<li>output/parent_d1030_time course_Parent.png</li>
<li>output/parent_d1030_obs_pred_Parent.pdf</li>
<li>output/parent_d1030_obs_pred_Parent.png</li>
</ul>
<div class="figure">
<img src="Estimation-parent-tc.png" style="width:80.0%" alt=""><p class="caption">Timecourse</p>
</div>
<div class="figure">
<img src="Estimation-parent-op.png" style="width:80.0%" alt=""><p class="caption">Observed vs Predicted</p>
</div>
<div id="automated-reporting" class="section level3">
<h3 class="hasAnchor">
<a href="#automated-reporting" class="anchor" aria-hidden="true"></a>Automated Reporting</h3>
<p>The outputs above provide components for generating presentations and other documents. Coping and pasting these figures and tables into documents can be tedious. It can be convenient to automate this process and this is accomplished with the function <code><a href="../reference/system_rpt_estimation.html">system_rpt_estimation()</a></code>.</p>
<div id="powerpoint" class="section level4">
<h4 class="hasAnchor">
<a href="#powerpoint" class="anchor" aria-hidden="true"></a>PowerPoint</h4>
<p>To append the results of an analysis to a PowerPoint document simply initialize a new report (<code>template="PowerPoint"</code>), call <code><a href="../reference/system_rpt_read_template.html">system_rpt_read_template()</a></code> with the appropriate <code>analysis_name</code>, and the results of the analysis will be attached as slides.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_rpt_read_template.html">system_rpt_read_template</a></span><span class="op">(</span><span class="va">cfg</span>, template<span class="op">=</span><span class="st">"PowerPoint"</span><span class="op">)</span>
<span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_rpt_estimation.html">system_rpt_estimation</a></span><span class="op">(</span>cfg<span class="op">=</span><span class="va">cfg</span>, analysis_name<span class="op">=</span><span class="va">analysis_name</span><span class="op">)</span>
<span class="fu"><a href="../reference/system_rpt_save_report.html">system_rpt_save_report</a></span><span class="op">(</span>cfg<span class="op">=</span><span class="va">cfg</span>,
 output_file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"output"</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">analysis_name</span>, <span class="st">"-report.pptx"</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>This will then save the analysis results to the <code>output</code> directory.</p>
</div>
<div id="word" class="section level4">
<h4 class="hasAnchor">
<a href="#word" class="anchor" aria-hidden="true"></a>Word</h4>
<p>The process for a Word document is the same. Just make sure that the <code>template</code> is set to <code>"Word"</code> when the report is initialized:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_rpt_read_template.html">system_rpt_read_template</a></span><span class="op">(</span><span class="va">cfg</span>, template<span class="op">=</span><span class="st">"Word"</span><span class="op">)</span>
<span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_rpt_estimation.html">system_rpt_estimation</a></span><span class="op">(</span>cfg<span class="op">=</span><span class="va">cfg</span>, analysis_name<span class="op">=</span><span class="va">analysis_name</span><span class="op">)</span>
<span class="fu"><a href="../reference/system_rpt_save_report.html">system_rpt_save_report</a></span><span class="op">(</span>cfg<span class="op">=</span><span class="va">cfg</span>,
output_file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"output"</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">analysis_name</span>, <span class="st">"-report.docx"</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>For more information on integrated report generation see the <code>Reporting</code> vignette.</p>
</div>
</div>
</div>
<div id="maximum-likelihoodtwo-outputs-analysis_parent_metabolite-r" class="section level2">
<h2 class="hasAnchor">
<a href="#maximum-likelihoodtwo-outputs-analysis_parent_metabolite-r" class="anchor" aria-hidden="true"></a>Maximum likelihood/two outputs (<code>analysis_parent_metabolite.r</code>)</h2>
<p>This example is similar to the last except we are analyzing two different outputs (parent and metabolite) and we have a proportional variance model. So now we can estimate the parameters associated with those outputs as well as the variance parameters:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pnames</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Vp'</span>,
           <span class="st">'Vt'</span>,
           <span class="st">'Vm'</span>,
           <span class="st">'CLp'</span>,
           <span class="st">'Q'</span>,
           <span class="st">'CLm'</span>,
           <span class="st">'slope_parent'</span>,
           <span class="st">'slope_metabolite'</span><span class="op">)</span>;

<span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_select_set.html">system_select_set</a></span><span class="op">(</span><span class="va">cfg</span>, <span class="st">"default"</span>, <span class="va">pnames</span><span class="op">)</span></code></pre></div>
<p>The parameters being estimated contain variance parameters (<code>slope_parent</code> and <code>slope_metabolite</code>) so a maximum likelihood objective will be used. The cohort definitions look much the same as those before except the variance model here is defined as <code>'slope_parent*PRED^2'</code>, and there is a separate output named <code>Metabolite</code>.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cohort</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
  name         <span class="op">=</span> <span class="st">"dose_10"</span>,
  cf           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>DOSE      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span>,
  inputs       <span class="op">=</span> <span class="cn">NULL</span>,
  outputs      <span class="op">=</span> <span class="cn">NULL</span>,
  dataset      <span class="op">=</span> <span class="st">"pm_data"</span><span class="op">)</span>


<span class="co"># Bolus inputs for the cohort</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"inputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"bolus"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"inputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"bolus"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Mpb"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="cn">NULL</span>, AMT<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"inputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"bolus"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Mpb"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"TIME"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">0</span><span class="op">)</span> <span class="co"># hours </span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"inputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"bolus"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Mpb"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"AMT"</span><span class="op">]</span><span class="op">]</span>  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="co"># mpk </span>


<span class="co"># Defining Parent output</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Parent"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># Mapping to data set</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Parent"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"obs"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
         time           <span class="op">=</span> <span class="st">"TIME"</span>,
         value          <span class="op">=</span> <span class="st">"PT"</span>,
         missing        <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>

<span class="co"># Mapping to system file</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Parent"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"model"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
         time           <span class="op">=</span> <span class="st">"hours"</span>,       
         value          <span class="op">=</span> <span class="st">"Cpblood"</span>,   
         variance       <span class="op">=</span> <span class="st">"slope_parent*PRED^2"</span><span class="op">)</span>

<span class="co"># Plot formatting</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Parent"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"options"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
         marker_color   <span class="op">=</span> <span class="st">"black"</span>,
         marker_shape   <span class="op">=</span> <span class="fl">1</span>,
         marker_line    <span class="op">=</span> <span class="fl">1</span> <span class="op">)</span>

<span class="co"># Defining Metabolite output</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Metabolite"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># Mapping to data set</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Metabolite"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"obs"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
         time           <span class="op">=</span> <span class="st">"TIME"</span>,
         value          <span class="op">=</span> <span class="st">"MT"</span>,
         missing        <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>

<span class="co"># Mapping to system file</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Metabolite"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"model"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
         time           <span class="op">=</span> <span class="st">"hours"</span>,       
         value          <span class="op">=</span> <span class="st">"Cmblood"</span>,   
         variance       <span class="op">=</span> <span class="st">"slope_metabolite*PRED^2"</span><span class="op">)</span>

<span class="co"># Plot formatting</span>
<span class="va">cohort</span><span class="op">[[</span><span class="st">"outputs"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"Metabolite"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"options"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
         marker_color   <span class="op">=</span> <span class="st">"blue"</span>,
         marker_shape   <span class="op">=</span> <span class="fl">1</span>,
         marker_line    <span class="op">=</span> <span class="fl">1</span> <span class="op">)</span>

<span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_define_cohort.html">system_define_cohort</a></span><span class="op">(</span><span class="va">cfg</span>, <span class="va">cohort</span><span class="op">)</span></code></pre></div>
<p>Similar modifications were made to the 30 mg dosing cohort.</p>
</div>
<div id="global-estimation-routines-analysis_parent_metabolite_global-r" class="section level2">
<h2 class="hasAnchor">
<a href="#global-estimation-routines-analysis_parent_metabolite_global-r" class="anchor" aria-hidden="true"></a>Global estimation routines (<code>analysis_parent_metabolite_global.r</code>)</h2>
<p>Now we build on the previous example to demonstrate how to select different optimization routines. By default, the parameter estimation is carried out using the <code>Nelder-Mead</code> optimization method from the <code>optim</code> library. You can specify different functions in the library. See the documentation for optim (?optim) for valid values for method and elements for the control. For example, to use simulated annealing change the <code>method</code> to <code>SANN</code>.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_set_option.html">system_set_option</a></span><span class="op">(</span><span class="va">cfg</span>, group  <span class="op">=</span> <span class="st">"estimation"</span>,
                             option <span class="op">=</span> <span class="st">"method"</span>,
                             value  <span class="op">=</span> <span class="st">"SANN"</span><span class="op">)</span></code></pre></div>
<p>There are also global optimization libraries in R, and two of these can be readily used with ubiquity: Particle Swarm Optimizer (<code>pso</code> package) and Genetic Algorithms (<code>GA</code> package).</p>
<p>To use the <code>pso</code> package set the following options:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"pso"</span><span class="op">)</span>
<span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_set_option.html">system_set_option</a></span><span class="op">(</span><span class="va">cfg</span>, group  <span class="op">=</span> <span class="st">"estimation"</span>,
                             option <span class="op">=</span> <span class="st">"optimizer"</span>, 
                             value  <span class="op">=</span> <span class="st">"pso"</span><span class="op">)</span>

<span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_set_option.html">system_set_option</a></span><span class="op">(</span><span class="va">cfg</span>, group  <span class="op">=</span> <span class="st">"estimation"</span>,
                             option <span class="op">=</span> <span class="st">"method"</span>,
                             value  <span class="op">=</span> <span class="st">"psoptim"</span><span class="op">)</span></code></pre></div>
<p>To use the <code>GA</code> package set the following options:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://luca-scr.github.io/GA/" class="external-link">GA</a></span><span class="op">)</span>

<span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_set_option.html">system_set_option</a></span><span class="op">(</span><span class="va">cfg</span>, group  <span class="op">=</span> <span class="st">"estimation"</span>,
                             option <span class="op">=</span> <span class="st">"optimizer"</span>, 
                             value  <span class="op">=</span> <span class="st">"ga"</span><span class="op">)</span>

<span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_set_option.html">system_set_option</a></span><span class="op">(</span><span class="va">cfg</span>, group  <span class="op">=</span> <span class="st">"estimation"</span>,
                             option <span class="op">=</span> <span class="st">"method"</span>,
                             value  <span class="op">=</span> <span class="st">"ga"</span><span class="op">)</span>

<span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_set_option.html">system_set_option</a></span><span class="op">(</span><span class="va">cfg</span>, group  <span class="op">=</span> <span class="st">"estimation"</span>,
                             option <span class="op">=</span> <span class="st">"control"</span>, 
                             value  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxiter   <span class="op">=</span> <span class="fl">10000</span>, 
                                           optimArgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>method  <span class="op">=</span> <span class="st">"Nelder-Mead"</span>,
                                                            maxiter <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><strong>Note:</strong> Optimizers like <code>SANN</code> and the global optimizers (<code>pso</code> and <code>GA</code>) are good for identifying parameter sets outside of the region of the initial guess. However, one consequence of these algorithms is they can quickly approach the bounds. Consequently it is important to provide realistic upper and lower bounds on the parameters (the <code>&lt;P&gt;</code> descriptor in the system file or using <code><a href="../reference/system_set_guess.html">system_set_guess()</a></code> at the scripting level). If you use the default value of machine precision (<code>eps</code>) for the lower bound and infinity (<code>Inf</code>) for the upper bound these optimization routines can choose parameter values that can cause the internal simulations to fail.</p>
</div>
<div id="cohorts-from-nonmem-dataset-analysis_parent_metabolite_nm_data-r" class="section level2">
<h2 class="hasAnchor">
<a href="#cohorts-from-nonmem-dataset-analysis_parent_metabolite_nm_data-r" class="anchor" aria-hidden="true"></a>Cohorts from NONMEM dataset (<code>analysis_parent_metabolite_nm_data.r</code>)</h2>
<p>In the examples above, cohorts are defined manually. Sometimes you may have data in a NONMEM dataset where the dosing information is located in the dataset. It may be convenient to simply define a cohort for each subject in the dataset. To do that the function <code>system_define_cohorts_nm</code> can be used. The differences between the script <code>analysis_parent_metabolite.r</code> will now be highlighted:</p>
<p>First we load the NONMEM dataset and clear the cohorts:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_load_data.html">system_load_data</a></span><span class="op">(</span><span class="va">cfg</span>, dsname     <span class="op">=</span> <span class="st">"nm_pm_data"</span>, 
                            data_file  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"ubinc"</span>, <span class="st">"csv"</span>,
                                                     <span class="st">"nm_data.csv"</span>, 
                                                     package <span class="op">=</span> <span class="st">"ubiquity"</span><span class="op">)</span><span class="op">)</span>
<span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_clear_cohorts.html">system_clear_cohorts</a></span><span class="op">(</span><span class="va">cfg</span><span class="op">)</span>;</code></pre></div>
<p>Next we define a filter to use on the dataset (include only the 10 and 30 mg doses):</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filter</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">filter</span><span class="op">$</span><span class="va">DOSE</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">30</span><span class="op">)</span></code></pre></div>
<p>For more information on filtering datasets see the help for <code><a href="../reference/nm_select_records.html">nm_select_records()</a></code>.</p>
<p>Now we define maps for the different outputs. For each output we specify the variance, compartment (<code>CMT</code>) number, model output and the missing number flag:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">OBSMAP</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">OBSMAP</span><span class="op">$</span><span class="va">PT</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>variance     <span class="op">=</span> <span class="st">'slope_parent*PRED^2'</span>,
                 CMT          <span class="op">=</span>  <span class="fl">1</span>,
                 output       <span class="op">=</span> <span class="st">'Cpblood'</span>, 
                 missing      <span class="op">=</span>  <span class="op">-</span><span class="fl">1</span> <span class="op">)</span>

<span class="va">OBSMAP</span><span class="op">$</span><span class="va">MT</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>variance     <span class="op">=</span> <span class="st">'slope_metabolite*PRED^2'</span>,
                 CMT          <span class="op">=</span>  <span class="fl">2</span>,
                 output       <span class="op">=</span> <span class="st">'Cmblood'</span>, 
                 missing      <span class="op">=</span>  <span class="op">-</span><span class="fl">1</span> <span class="op">)</span></code></pre></div>
<p>Lastly we define a map for the model inputs. In this case we only have a bolus in the <code>Mpb</code> compartment:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">INPUTMAP</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">INPUTMAP</span><span class="op">$</span><span class="va">bolus</span><span class="op">$</span><span class="va">Mpb</span><span class="op">$</span><span class="va">CMT_NUM</span>             <span class="op">=</span>  <span class="fl">1</span></code></pre></div>
<p>Unused columns in the dataset will be ignored. With the filter, input and observation maps defined, we now add the cohorts</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cfg</span> <span class="op">=</span> <span class="fu"><a href="../reference/system_define_cohorts_nm.html">system_define_cohorts_nm</a></span><span class="op">(</span><span class="va">cfg</span>, 
                               DS       <span class="op">=</span> <span class="st">'nm_pm_data'</span>,
                               col_ID   <span class="op">=</span> <span class="st">'ID'</span>,   col_CMT  <span class="op">=</span> <span class="st">'CMT'</span>, col_DV   <span class="op">=</span> <span class="st">'DV'</span>,
                               col_TIME <span class="op">=</span> <span class="st">'TIME'</span>, col_AMT  <span class="op">=</span> <span class="st">'AMT'</span>, col_RATE <span class="op">=</span> <span class="st">'RATE'</span>,
                               col_EVID <span class="op">=</span> <span class="st">'EVID'</span>, col_GROUP<span class="op">=</span> <span class="st">'DOSE'</span>,
                               filter   <span class="op">=</span>  <span class="va">filter</span>, 
                               INPUTS   <span class="op">=</span>  <span class="va">INPUTMAP</span>,
                               OBS      <span class="op">=</span>  <span class="va">OBSMAP</span>,
                               group    <span class="op">=</span>  <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div id="contents-of-system-txt" class="section level2">
<h2 class="hasAnchor">
<a href="#contents-of-system-txt" class="anchor" aria-hidden="true"></a>Contents of <code>system.txt</code>
</h2>
<pre><code>#
# Parent/Metabolite example taken from Section 9.3 of the ADAPT5 Users Manual
#
# https://bmsr.usc.edu/files/2013/02/ADAPT5-User-Guide.pdf
#
&lt;P&gt; Vp    10.0   1e-5   100  L        yes       System     
&lt;P&gt; Vt    10.0   1e-5   100  L        yes       System     
&lt;P&gt; Vm    30.0   1e-5   100  L        yes       System
&lt;P&gt; CLp    1.0   1e-5   100  L/hr     yes       System
&lt;P&gt; CLm    1.0   1e-5   100  L/hr     yes       System
&lt;P&gt; Q      0.3   1e-5   100  L/hr     yes       System

&lt;PSET:default&gt; Original Estimates

&lt;VP&gt; slope_parent     0.1  1e-9    10  --  no Variance
&lt;VP&gt; slope_metabolite 0.1  1e-9    10  --  no Variance

&lt;B:times&gt;;           [  0  ];      1;          hours
&lt;B:events&gt;;   Mpb;   [  0  ];     70;          mpk

&lt;ODE:Mpb&gt; -(CLp/Vp + Q/Vp)*Mpb + Q/Vt*Mpt 
&lt;ODE:Mpt&gt; Q/Vp*Mpb - Q/Vt*Mpt
&lt;ODE:Mmb&gt; CLp/Vp*Mpb  - CLm/Vm*Mmb

&lt;O&gt; Cpblood     = Mpb/Vp
&lt;O&gt; Cmblood     = Mmb/Vm   

&lt;TS:hours&gt; 1.0
&lt;TS:days&gt;  1.0/24.0

&lt;IIV:ETAVp&gt;    0.08       
&lt;IIV:ETAVp:LN&gt; Vp     
&lt;IIV:ETAVt&gt;    0.08       
&lt;IIV:ETAVt:LN&gt; Vt     
&lt;IIV:ETACLp&gt;   0.08       
&lt;IIV:ETACLp:LN&gt; CLp
&lt;IIV:ETACLm&gt;   0.08       
&lt;IIV:ETACLm:LN&gt; CLm


&lt;OPT:output_times&gt; SIMINT_SEQ[0][100][1]
&lt;DATA:HEADER:AUTOMATIC&gt;</code></pre>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>analysis names must start with a letter and containing only letters, numbers, and _<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>The objective function is set based on the parameters being estimated. If there are no variance parameters being estimated a weighted least squares objective will be used. If there are variance parameters being estimated then a maximum likelihood objective will be used.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>dataset names must start with a letter and containing only letters, numbers, and _<a href="#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>cohort names must start with a letter and containing only letters, numbers, and _<a href="#fnref4" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by John Harrold.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
