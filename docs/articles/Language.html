<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Modeling Language • ubiquity</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Modeling Language">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ubiquity</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.0.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-chalkboard-teacher"></span> Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Getting Started</h6></li>
    <li><a class="dropdown-item" href="../articles/Simulation.html">Individual and Population Simulations</a></li>
    <li><a class="dropdown-item" href="../articles/Language.html">ubiquity Modeling Language</a></li>
    <li><a class="dropdown-item" href="../articles/Estimation.html">Naive-Pooled Parameter Estimation</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Other Analysis Options</h6></li>
    <li><a class="dropdown-item" href="../articles/Deployment.html">Deploying Your Models in a Shiny App</a></li>
    <li><a class="dropdown-item" href="../articles/Titration.html">Trial/Rule-Based Simulations</a></li>
    <li><a class="dropdown-item" href="../articles/NCA.html">Non-Compartmental Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/Reporting.html">Integrated Word and PowerPoint Reporting</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>More Help</h6></li>
    <li><a class="dropdown-item" href="../articles/Howto.html">Howtos</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-screencasts" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-video"></span> Screencasts</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-screencasts">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Modeling</h6></li>
    <li><a class="external-link dropdown-item" href="https://vimeo.com/382859445">Individual and Population Simulations</a></li>
    <li><a class="external-link dropdown-item" href="https://vimeo.com/382860283">Model Deployment</a></li>
    <li><a class="external-link dropdown-item" href="https://vimeo.com/manage/videos/382829588">Naive-Pooled Parameter Estimation</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Other Tools</h6></li>
    <li><a class="external-link dropdown-item" href="https://vimeo.com/650643574">Tabula: Extracting Tabular Data from PDFs</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fas fa-hat-wizard"></span> Functions</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html"><span class="fa fas fa-rss"></span> News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/john-harrold/ubiquity/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Modeling Language</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/john-harrold/ubiquity/blob/HEAD/vignettes/Language.Rmd" class="external-link"><code>vignettes/Language.Rmd</code></a></small>
      <div class="d-none name"><code>Language.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>At its core, ubiquity is a modeling language and a set of scripts
meant to facilitate model development and deployment. The focus of this
document is on the model description language. This is a plain text
file, referred to as a <strong>system file</strong>. Each line contains
a descriptor (e.g. <code>&lt;P&gt;</code>) which defines an aspect of
the model, and comments are made with the hash sign (<code>#</code>).
What follows is an overview of the different components of the language
that can be used to create a system file.</p>
</div>
<div class="section level2">
<h2 id="parameters">Parameters<a class="anchor" aria-label="anchor" href="#parameters"></a>
</h2>
<div class="section level3">
<h3 id="system-parameters-p">System parameters <code>&lt;P&gt;</code><a class="anchor" aria-label="anchor" href="#system-parameters-p"></a>
</h3>
<p>Each system parameter is specified with a name, value, lower bound,
upper bound, units, whether it should be editable in the ShinyApp and
the ‘type’ of parameter (grouping in the ShinyApp). The values of eps
(machine precision, smallest value that is not zero) and inf (infinity)
can be used. For example to specify a parameter koffR with a value of .1
that is positive and a parameter KDR with a value of .04 that is also
positive the following would be used:</p>
<pre><code>#   name  value    lb     ub   units  editable type
&lt;P&gt; koffR 0.1      eps    inf   1/hr  yes      Target
&lt;P&gt; KDR   0.04     eps    inf   nM    yes      Target</code></pre>
</div>
<div class="section level3">
<h3 id="parameter-sets">Parameter sets<a class="anchor" aria-label="anchor" href="#parameter-sets"></a>
</h3>
<p>Often a model will be developed to incorporate different situations
or scenarios. For example, a model may be used to describe both healthy
and diseased individuals. When these differences are simply parametric
in nature, it can be cumbersome to code a model multiple times (once for
each parameterization). This framework provides a mechanism for
including multiple parameterizations withing the same system file.
Consider the system below where we want to describe antibody
disposition. For humans this is described by a two compartment model,
but for mice a single compartment is needed.</p>
<div class="float">
<img src="system-paper-parameter_sets.png" style="width:60.0%" alt="Model parameterizations"><div class="figcaption">Model parameterizations</div>
</div>
<p>First we create a set of parameters describing the human scenario.
These are the mean parameters taken from the literature [DM]:</p>
<pre><code>&lt;P&gt; Weight   70.0    eps inf kg   yes   System # Organism weight
&lt;P&gt; CL        0.0129 eps inf L/hr yes   System # Systemic Clearance
&lt;P&gt; Q         0.0329 eps inf L/hr yes   System # Inter-compartmental clearance
&lt;P&gt; Vp        3.1    eps inf L    yes   System # Vol. central compartment
&lt;P&gt; Vt        2.8    eps inf L    yes   System # Vol. peripheral compartment</code></pre>
<p>When a parameter is created using the <code>&lt;P&gt;</code>
descriptor it is part of the <code>default</code> parameter set. This is
the short name<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;parameter set short names must start with a letter and
containing only letters, numbers, and _&lt;/p&gt;"><sup>1</sup></a> for a parameter set. A longer more verbose
name can be given as well, and this is what will be seen in the
ShinyApp. The human parameter set can be labeled using the
<code>PSET</code> descriptor in the following way:</p>
<pre><code>&lt;PSET:default&gt; mAb in Human</code></pre>
<p>Where <code>default</code> is the parameter set short name name, and
“mAb in Human” is the value shown to the user in the ShinyApp.</p>
<p>Next, to add the parameterization for mice we simply create a new set
in the following way:</p>
<pre><code>&lt;PSET:mouse&gt; mAb in Mouse</code></pre>
<p>This alone would create a new parameter set with a short name
<code>mouse</code>, and is an exact copy of the default parameter set.
To identify the parametric differences between the <code>mouse</code>
and <code>human</code> we use <code>PSET</code> in the following
way:</p>
<pre><code>&lt;PSET:mouse:Weight &gt; 0.020 # 20 gram mouse
&lt;PSET:mouse:CL &gt;     7.71e-6
&lt;PSET:mouse:Q&gt;       0.0
&lt;PSET:mouse:Vp &gt;     1.6e-3
&lt;PSET:mouse:Vt &gt;     1   # arbitrary</code></pre>
<p>Consider the clearance parameter entry where we want the murine
half-life of an antibody [VR]:</p>
<pre><code>&lt;PSET:mouse:CL&gt; 7.71e-6</code></pre>
<p>We use the set name (<code>mouse</code>) and the parameter name
(<code>CL</code>) and then we overwrite the default with the specified
value <code>7.71e-6</code>. The other aspects of the parameter (bounds,
edit flag, etc.) will be the same as the default value.</p>
</div>
<div class="section level3">
<h3 id="secondary-parameters-as-and-ad">Secondary parameters <code>&lt;As&gt;</code> and
<code>&lt;Ad&gt;</code><a class="anchor" aria-label="anchor" href="#secondary-parameters-as-and-ad"></a>
</h3>
<p>A static secondary parameter refers to parameter does not change
during a simulation. These are specified using the
<code>&lt;As&gt;</code> descriptor and can be written in terms of system
parameters or previously defined static secondary parameters. These can
be used in differential equations, defining initial conditions, input
scaling and model outputs. This is similar to secondary parameters
defined in the <code>$PK</code> block in NONMEM. For example, if you
wanted to define the rate of elimination in terms of the system
parameters for clearance <code>CL</code> and volume of distribution
<code>Vp</code> the following would be used:</p>
<pre><code>&lt;As&gt; kel = CL/Vp</code></pre>
<p>A dynamic secondary parameters refers to a parameter that can change
during a simulation. This typically means it is defined, using the
<code>&lt;Ad&gt;</code> descriptor, in terms of a state or another
dynamic secondary parameter. These can be used in differential equations
and model outputs. These are similar to the parameters defined in the
<code>$DES</code> block in NONMEM. For example if you wanted to use the
concentration in the central compartment <code>Cp</code> but it was
dependent on the amount in that compartment <code>Ap</code> and the
volume of that compartment <code>Vp</code> the following would be
used:</p>
<pre><code>&lt;Ad&gt; Cp = Ap/Vp</code></pre>
</div>
<div class="section level3">
<h3 id="variance-parameters-vp">Variance parameters <code>&lt;VP&gt;</code><a class="anchor" aria-label="anchor" href="#variance-parameters-vp"></a>
</h3>
<p>Variance parameters are specified using the same format as system
parameters (<code>&lt;P&gt;</code>) :</p>
<pre><code>#    name    value lower_bound upper_bound units editable grouping
&lt;VP &gt; SLOPE  0.01  eps         inf         1/hr   yes     Variance</code></pre>
<p>The difference being that the <code>&lt;VP&gt;</code> descriptor is
used and that the grouping is set to <code>Variance</code>. These are
used when performing parameter estimation and when simulating with
residual variability.</p>
</div>
<div class="section level3">
<h3 id="parameter-estimation-information-est">Parameter estimation information <code>&lt;EST:?&gt;?</code><a class="anchor" aria-label="anchor" href="#parameter-estimation-information-est"></a>
</h3>
<p><em>Currently applies only to nlmixr2/rxode2. Essentially all the
parameters not listed here will be fixed.</em></p>
<p>This descriptor specifies information about parameters for
estimation. Sometimes it is necessary to estimate parameters in the log
space. Here you can specify the parmaeters to log transform (LT). If you
wanted to log transform parameters <code>P1</code>, <code>P2</code>, and
<code>P3</code> you would do the following:</p>
<pre><code>&lt;EST:LT&gt; P1; P2; P3</code></pre>
<p><em>NOTE That for the Monolix outputs to work correctly you will need
to logtransform any parameters that have log-normal IIV
assigned.</em></p>
<p>By default all parameters will be specified for estimation. If you
want to estimate a subset of parameters (P), say <code>P1</code> and
<code>P2</code>, you can use the following:</p>
<pre><code>&lt;EST:P&gt; P1; P2</code></pre>
</div>
<div class="section level3">
<h3 id="output-error-model-oe">Output error model <code>&lt;OE:?&gt; ?</code><a class="anchor" aria-label="anchor" href="#output-error-model-oe"></a>
</h3>
<p><em>Current applies only to nlmixr2/rxode2 output. </em></p>
<p>This defines the output error model of the format:</p>
<pre><code><span><span class="va">`&lt;OE:OUTPUT&gt; expression`</span></span></code></pre>
<p>The <code>OUTPUT</code> can be the name of any output defined with
<code>&lt;O&gt;</code>. The <code>expression</code> is a model type (add
for additive, and prop for proportional) with an equal sign and the name
of the variance paramter (<code>&lt;VP&gt;</code>) to use. To use more
than one error model type you separate the statments with <code>;</code>
For example if you define the variance parameters <code>add_err</code>
and <code>prop_err</code> and want to use a proportional error model to
the output Cp you would use:</p>
<pre><code>&lt;OE:Cp&gt; prop=prop_err</code></pre>
<p>To use both additive and proportional error the following would
work:</p>
<pre><code>&lt;OE:Cp&gt; add=add_err; prop=prop_err</code></pre>
</div>
<div class="section level3">
<h3 id="variability-defining-the-variancecovariance-matrix-iiv-iivcor">Variability: defining the variance/covariance Matrix
<code>&lt;IIV:?&gt;?</code> &amp; <code>&lt;IIVCOR:?&gt;?</code><a class="anchor" aria-label="anchor" href="#variability-defining-the-variancecovariance-matrix-iiv-iivcor"></a>
</h3>
<p>Any variable name assigned to inter-individual variability (IIV) or
correlation/covariance (IIVCOR) term that makes sense to the user may be
used. The following sample codes have variable names (eg: ETACL) that
most likely make sense to a population modeler or NONMEM user. To define
an IIV term named <code>ETACL</code> with a variance of
<code>0.15</code> use the following:</p>
<pre><code>&lt;IIV:ETACL&gt; 0.15</code></pre>
<p>The next we need to associate this IIV term with a system parameter.
To associate this IIV term with the clearance (system parameter
<code>CL</code>) and specify that it has a log normal distribution
(<code>LN</code>) we would simply write:</p>
<pre><code>&lt;IIV:ETACL:LN&gt; CL</code></pre>
<p>Alternatively a normal (<code>N</code>) distribution can be used.</p>
<p>Next we specify the IIV term <code>ETAV</code> with a variance of
<code>0.1</code>. This IIV term also has a log normal distribution and
is applied to the parameter <code>V</code>:</p>
<pre><code>&lt;IIV:ETAV&gt; 0.10
&lt;IIV:ETAV:LN&gt; V</code></pre>
<p>Now we can define the covariance (off-diagonal elements) between
<code>CL</code> and <code>V</code> to be <code>0.01</code> by using:</p>
<pre><code>&lt;IIVCOR:ETAV:ETACL&gt; 0.01</code></pre>
<p>The order isn’t important and the IIV terms can be reversed</p>
</div>
<div class="section level3">
<h3 id="iiv-and-parameter-sets-iivset-iivcorset">IIV and parameter sets <code>&lt;IIVSET:?&gt;?</code> &amp;
<code>&lt;IIVCORSET:?&gt;?</code><a class="anchor" aria-label="anchor" href="#iiv-and-parameter-sets-iivset-iivcorset"></a>
</h3>
<p>By default all parameter sets will have inter individual variability
specified using the <code>&lt;IIV&gt;</code> and
<code>&lt;IIVCOR&gt;</code> descriptors. To associate a specific set of
IIVs to a parameter set use the <code>&lt;IIVSET&gt;</code> and
<code>&lt;IIVCORSET&gt;</code> descriptors. These set descriptors
operate differently than the parameter set descriptors
(<code>&lt;PSET&gt;</code>). The <code>&lt;PSET&gt;</code> just
overwrites the default values and inherits the default
variance/covariance information. If you alter the IIV information for a
parameter set it will <em>reset</em> the IIV information for that
parameter set. The entire variance covariance matrix will need to be
specified for that parameter set.</p>
<p>If the parameter set <code>MYPSET</code> has been defined then the
following could be used to define the IIV for the parameters
<code>Q</code> and <code>CL</code>:</p>
<pre><code>&lt;IIVSET:MYPSET:ETAQ&gt;           0.05
&lt;IIVSET:MYPSET:ETAQ:LN&gt;        Q

&lt;IIVSET:MYPSET:ETACL&gt;          0.25
&lt;IIVSET:MYPSET:ETACL:LN&gt;       CL

&lt;IIVCORSET:MYPSET:ETAQ:ETACL&gt;  0.01</code></pre>
<p>All the other system parameters will have no IIV information for this
parameter set.</p>
</div>
</div>
<div class="section level2">
<h2 id="differential-equations">Differential equations<a class="anchor" aria-label="anchor" href="#differential-equations"></a>
</h2>
<p>The differential equations in the system can be defined by simply
writing them out. Alternative they can ‘built’ by using the different
descriptors provided below. Part of the flexibility of ubiquity lies in
the ability to combine these different notations. To construct a model
(see section below: Bringing it all together) any combination of the
five following methods can be used:</p>
<ol style="list-style-type: decimal">
<li>Differential equations <code>&lt;ODE:?&gt;</code>
</li>
<li>Reaction rates <code>=?=&gt;</code>
</li>
<li>Equilibrium relationships
<code>&lt;=kforward:kreverse=&gt;</code>
</li>
<li>Sources and sinks <code>&lt;S:?&gt;</code>
</li>
<li>Movement between compartments <code>&lt;C&gt;</code>
</li>
</ol>
<div class="section level3">
<h3 id="writing-odes-ode">Writing ODEs <code>&lt;ODE:?&gt;</code><a class="anchor" aria-label="anchor" href="#writing-odes-ode"></a>
</h3>
<p>Portions of differential equations can be specified here where ? is
the state or compartment. To define <code>dA/dT</code> as
<code>koffR*C - konR*A*B</code> we would write:</p>
<pre><code>&lt;ODE:A&gt; koffR*C - konR*A*B </code></pre>
<p>It might be more convenient to specify an ODE across several lines,
making things more readable. Just use multiple statements and they will
be appended together. This would give the same result as the example
above:</p>
<pre><code>&lt;ODE:A&gt;    koffR*C
&lt;ODE:A&gt;  - konR*A*B </code></pre>
</div>
<div class="section level3">
<h3 id="rate-equations">Rate equations <code>=?=&gt;</code><a class="anchor" aria-label="anchor" href="#rate-equations"></a>
</h3>
<p>It may be more convenient to write out chemical reactions rather than
differential equations. This can be done using the general form:</p>
<pre><code>[CR1]Reactant1 + [CR2]Reactant2 + ... =kf=&gt; [CP1]Product1 + [CP2]Product2 + ...</code></pre>
<p>Where the stoichiometric coefficients, beginning with <code>CR</code>
and <code>CP</code> above, in brackets only need to be specified if they
are not one. The reaction order will be assumed to be equal to the
stoichiometric coefficient of the reactant. For a more specific example
Consider decomposition of hydrogen peroxide into water and oxygen:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mn>2</mn></msub><msub><mi>O</mi><mn>2</mn></msub><mover><mo>→</mo><msub><mi>k</mi><mrow><mi>d</mi><mi>e</mi><mi>g</mi></mrow></msub></mover><msub><mi>H</mi><mn>2</mn></msub><mi>O</mi><mo>+</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msub><mi>O</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex"> H_2O_2 \xrightarrow{k_{deg}} H_2O + \frac{1}{2}O_2 </annotation></semantics></math></p>
<p>In the system format this would be written in the following
manner:</p>
<pre><code>H2O2 =kdeg=&gt; H2O + [0.5]O2</code></pre>
<p>And this will be translated in to the following differential
equations:</p>
<p><span class="math display">$$
\frac{dH_2O_2}{dt}=-k_{deg}H_2O_2 \\
\frac{dH_2O}{dt}= k_{deg}H_2O_2 \\
\frac{dO_2}{dt}= 0.5k_{deg}H_2O_2
$$</span></p>
<p>Which could also be defined as differential equations using the
<code>&lt;ODE:?&gt;?</code>. This is the equivalent:</p>
<pre><code>&lt;ODE:H2O2&gt;   - kdeg*H2O2 
&lt;ODE:H2O&gt;      kdeg*H2O2 
&lt;ODE:O2&gt;   0.5*kdeg*H2O2 </code></pre>
<p>The rates (e.g. <code>kdeg</code>) need to be defined as either a
system or secondary parameter. This is where you can put saturable
terms, such as Michaelis-Menten kinetics.</p>
</div>
<div class="section level3">
<h3 id="equilibrium-relationships-kforwardkreverse">Equilibrium relationships
<code>&lt;=kforward:kreverse=&gt;</code><a class="anchor" aria-label="anchor" href="#equilibrium-relationships-kforwardkreverse"></a>
</h3>
<p>Forward and reverse reaction rates can be written separately:</p>
<pre><code>A + B =konR=&gt;   C       
C     =koffR=&gt;  A + B</code></pre>
<p>Or these can be written as equilibrium equations with the forward
(<code>konR</code>) and reverse (<code>koffR</code>) rates specified
as:</p>
<pre><code>A + B  &lt;=konR:koffR=&gt;  C       </code></pre>
<p>To specify this reaction as differential equations, the following
could have also been used:</p>
<pre><code>&lt;ODE:A&gt;  koffR*C - konR*A*B
&lt;ODE:B&gt;  koffR*C - konR*A*B
&lt;ODE:C&gt; -koffR*C + konR*A*B</code></pre>
<p>The stoichiometric coefficients also define the reaction order here.
For example, to create the following equilibrium reaction:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>A</mi><mo>+</mo><mn>3</mn><mi>B</mi><msubsup><mo>⇄</mo><msub><mi mathvariant="normal">k</mi><mi mathvariant="normal">r</mi></msub><msub><mi mathvariant="normal">k</mi><mi mathvariant="normal">f</mi></msub></msubsup><mn>4</mn><mi>C</mi></mrow><annotation encoding="application/x-tex"> 2A + 3B \mathop{\rightleftarrows}^{\mathrm{k_f}}_{\mathrm{k_r}}  4C </annotation></semantics></math></p>
<p>This rate notation could be used in the system file:</p>
<pre><code>[2]A + [3]B  &lt;=kf:kr=&gt;  [4]C       </code></pre>
<p>Which will produce the following in terms of differential
equations:</p>
<p><span class="math display">$$
\frac{dA}{dt} = 2k_rC^4 - 2k_fA^2B^3 \\
\frac{dB}{dt} = 3k_rC^4 - 3k_fA^2B^3 \\
\frac{dC}{dt} =-4k_rC^4 + 4k_fA^2B^3
$$</span> To write this equilibrium reaction as differential equations
the following would be used:</p>
<pre><code>&lt;ODE:A&gt;   =  2*kr*SIMINT_POWER[C][4] - 2*kf*SIMINT_POWER[A][2]*SIMINT_POWER[B][3]
&lt;ODE:B&gt;   =  3*kr*SIMINT_POWER[C][4] - 3*kf*SIMINT_POWER[A][2]*SIMINT_POWER[B][3]
&lt;ODE:C&gt;   = -4*kr*SIMINT_POWER[C][4] + 4*kf*SIMINT_POWER[A][2]*SIMINT_POWER[B][3]</code></pre>
<p>See below about generic functions such as
<code>SIMINT_POWER[][]</code>.</p>
</div>
<div class="section level3">
<h3 id="sources-and-sinks-s">Sources and sinks <code>&lt;S:?&gt;</code><a class="anchor" aria-label="anchor" href="#sources-and-sinks-s"></a>
</h3>
<p>This method allows turnover to be described in terms of synthesis and
degradation terms. If <code>A</code> is produced at a rate of
<code>ksynA</code> (mass quantities), degraded at a rate of
<code>kdegA</code>, and modeled in concentration units then the sources
are specified on the left hand side of <code>&lt;S:?&gt;</code> and the
sinks (elimination) are specified on the left hand side of
<code>&lt;S:?&gt;</code>. Multiple sources and sinks can be separated by
semicolons. In this example with a compartment volume <code>V</code></p>
<pre><code>ksynA/V &lt;S:A&gt; kdeg*A</code></pre>
<p>Which is the same as writing out the differential equation:</p>
<pre><code>&lt;ODE:A&gt; koffR*C - konR*A*B + ksynA/V - kdeg*A</code></pre>
</div>
<div class="section level3">
<h3 id="movement-between-compartments-c">Movement between compartments <code>&lt;C&gt;</code><a class="anchor" aria-label="anchor" href="#movement-between-compartments-c"></a>
</h3>
<p>When mass moves between two physical spaces with different volumes we
need to specify, for each compartment, the species, volume and rate of
transport. The <code>&lt;C&gt;</code> descriptor allows us to just
identify the compartment information separated by semicolons (order is
important)</p>
<pre><code>Species; Volume; Rate &lt;C&gt; Species; Volume; Rate</code></pre>
<p>For movement between a central compartment <code>A</code> with a
volume <code>V</code> to the tissue space <code>At</code> with a volume
<code>Vt</code> at rates <code>kps</code> and <code>ksp</code>
respectively this is specified in the following manner:</p>
<pre><code>A; V; kps &lt;C&gt; At; Vt; ksp</code></pre>
<p>Which is the equivalent of the following differential equation:</p>
<pre><code>&lt;ODE:A&gt;   -kps*A + ksp*At*Vt/V
&lt;ODE:At&gt;  +kps*A*V/Vt - ksp*At</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="bringing-it-all-together">Bringing it all together<a class="anchor" aria-label="anchor" href="#bringing-it-all-together"></a>
</h2>
<div class="float">
<img src="system-tmdd.png" style="width:60.0%" alt="ODEs vs. Model Descriptors"><div class="figcaption">ODEs vs. Model Descriptors</div>
</div>
<p>As a final example consider the target-mediated drug disposition
system above. This system can be defined with a set of ODES:</p>
<pre><code>&lt;ODE:Ct&gt;  Cp*kpt*Vp/Vt - Ct*ktp
&lt;ODE:Cp&gt; -Cp*kpt       + Ct*ktp*Vt/Vp -  kel*Cp   + koff*CpTp - kon*Cp*Tp
&lt;ODE:Tp&gt;               + ksyn/Vp      - kint*Tp   + koff*CpTp - kon*Cp*Tp
&lt;ODE:CpTp&gt;                            - kint*CpTp - koff*CpTp + kon*Cp*Tp</code></pre>
<p>Or it could simply be defined in terms of the underlying
processes:</p>
<pre><code># tissue distribution
Ct; Vt; ktp &lt;C&gt; Cp; Vp; kpt

# equilibrium
Cp + Tp &lt;=kon:koff=&gt; CpTp

# Turnover
 ksyn/Vp &lt;S:Tp&gt;   kint*Tp
         &lt;S:Cp&gt;    kel*Cp
         &lt;S:CpTp&gt; kint*CpTp</code></pre>
<div class="section level3">
<h3 id="initial-conditions-i">Initial conditions <code>&lt;I&gt;</code><a class="anchor" aria-label="anchor" href="#initial-conditions-i"></a>
</h3>
<p>By default all initial conditions are zero. You can specify a
non-zero initial condition using the <code>&lt;I&gt;</code> string to
set a ‘state’ to a ‘value’</p>
<pre><code>&lt;I&gt; state = value</code></pre>
<p>Value can be any combination of numbers, system parameters
<code>&lt;P&gt;</code> or static secondary parameters
<code>&lt;As</code>. Consider a turnover system where the value of
<code>ksyn</code> and <code>kdeg</code> are specified as parameters:</p>
<pre><code>&lt;P&gt; ksyn  0.1      eps    inf   1/hr  yes      Target
&lt;P&gt; kdeg  0.04     eps    inf   nM    yes      Target</code></pre>
<p>We can calculate the initial value for a target as:</p>
<pre><code>&lt;As&gt; T_IC = ksyn/kdeg</code></pre>
<p>Then we can specify the initial value of the target as:</p>
<pre><code>&lt;I&gt; T = T_IC</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="model-inputs">Model inputs<a class="anchor" aria-label="anchor" href="#model-inputs"></a>
</h2>
<p>Inputs into the model include typical interventions such as bolus
dosing or continuous infusions. However inputs here refers to
mathematical inputs. Typically covariates may be attributes of the
system (such as gender, or a specific genotype), but are treated here as
inputs. When defining inputs it is necessary to provide
typical/placeholder values. These provide default values for both the
ShinyApp interface as well as the scripting level (Matlab and R) where
they can be overwritten by the user.</p>
<div class="section level3">
<h3 id="bolus-dosing-btimes-bevents">Bolus dosing <code>&lt;B:times&gt;</code>,
<code>&lt;B:events&gt;</code><a class="anchor" aria-label="anchor" href="#bolus-dosing-btimes-bevents"></a>
</h3>
<p>The <code>&lt;B:?&gt;</code> descriptor is used to define bolus
dosing. Dosing information is broken down into a list of
<code>times</code> when bolus injections occur and a list of
<code>events</code> containing the amount the specified compartment will
receive.</p>
<p>Each of these has a <code>scale</code> that is used to convert the
bolus dosing information from proscribed units (mg daily) into the units
in which the system is coded (mg/mL and hours). So if dosing is done on
days 0, 1, 2… but the simulation time is hours, then the scale for the
dosing times is 24.The events contain the magnitude of the bolus at a
given time. If you want to dose into a central compartment
<code>Cp</code> in mg/kg and your central compartment is mg/mL then you
need to scale by the body weight (e.g. 70 kg) and the volume of your
central compartment (system or static secondary parameter
<code>Vp</code>) then the scale is <code>70/Vp</code>.</p>
<p>If you just want to create a palceholder you can do the
following:</p>
<pre><code>#  type       state   values    scale  units   
&lt;B:times&gt;;            [0];        24;  days   
&lt;B:events&gt;;     Cp;   [0];     70/Vc;  mpk   </code></pre>
<p>If you want to setup default dosing for the shiny app or scripts, you
can do somethign more complicated. If you have multiple compartments
receiving a bolus, the times must include all times in which a bolus may
be applied to the system. If a state does not receive a bolus on a
particular time, its magnitude at that time is 0.</p>
<p>To illustrate this consider the following dosing schedule:</p>
<div class="float">
<img src="dosing_bolus.png" style="width:50.0%" alt="Dosing into two different states/compartments"><div class="figcaption">Dosing into two different
states/compartments</div>
</div>
<p>In this example we want to dose two different drugs into two
different states/compartments. Drug 1 (<span style="color:purple"><strong>D1</strong></span>) will be dosed into
<code>Cp1</code> and drug 2 (<span style="color:orange"><strong>D2</strong></span>) into <code>Cp2</code>.
Dosing will be in mg/kg but concentrations are in mg/ml. The dosing time
is in days, but the simulation time units are hours. We will be dosing
<span style="color:purple"><strong>D1</strong></span> at <span style="color:purple"><strong>8</strong></span> &amp; <span style="color:purple"><strong>2</strong></span> mpk on days <span style="color:purple"><strong>0</strong></span> &amp; <span style="color:purple"><strong>6</strong></span>. <span style="color:orange"><strong>D2</strong></span> will be dosed at <span style="color:orange"><strong>5</strong></span> mpk on day <span style="color:orange"><strong>9</strong></span>.</p>
<pre><code>#  type       state     values     scale  units   
&lt;B:times&gt;;            [0 6 9];       24;  days   
&lt;B:events&gt;;    Cp1;   [8 2 0];    70/V1;  mpk   
&lt;B:events&gt;;    Cp2;   [0 0 5];    70/V2;  mpk   </code></pre>
<p>Assume <code>V1</code> and <code>V2</code> are the compartmental
volumes for <span style="color:purple"><strong>D1</strong></span> and
<span style="color:orange"><strong>D2</strong></span> in ml, and the
subject body weight is 70 kg. This would convert those doses in mpk into
mg/ml. <strong>Again these are the default doses that can be overwritten
both in the ShinyApp and within scripts.</strong></p>
</div>
<div class="section level3">
<h3 id="continuous-infusions-r">Continuous infusions <code>&lt;R:?&gt;</code><a class="anchor" aria-label="anchor" href="#continuous-infusions-r"></a>
</h3>
<p>Rates of infusion are defined using the <code>&lt;R:?&gt;</code>
descriptor. Like bolus values, infusion rates have two components. There
is a component that specifies switching times (e.g. switching from 10
mg/hr to 0). And each switching time has a corresponding rate of
infusion. This infusion rate will be held constant until the next time.
Also like the bolus specification there is a <strong>scale</strong>
associated with both infusion <code>times</code> and the
<code>levels</code> that converts the proscriptive units into the units
of the simulation. Consider the following example:</p>
<pre><code># name      time/levels values    scale  units
&lt;R:myrate&gt;; times;      [0 30];   1/60;    min
&lt;R:myrate&gt;; levels;     [1 0];    60;   mg/min</code></pre>
<p>These two entries create the infusion rate called
<code>myrate</code>. This can be used in any of your system
specifications (e.g., <code>&lt;ODE:Cp&gt; myrate/Vp</code>). The first
row specifies the times when the rate is changed (<code>0</code> and
<code>30</code> minutes). If the system is coded in terms of hours, then
the scale of <code>1/60</code> must be used. The levels indicate a rate
of <code>1</code> mg/min that is switched off at <code>30</code>
minutes. This has to be converted to mg/hr using the scale of
<code>60</code>. You can add as many paired rate entries as you need to
describe as many infusion interventions as necessary.</p>
<p><strong>Note:</strong> If you just want a placeholder you can just
set both of the values to <code>[0]</code>.</p>
</div>
<div class="section level3">
<h3 id="covariates-cv-cvset">Covariates <code>&lt;CV:?&gt;</code>,
<code>&lt;CVSET:?:?&gt;</code><a class="anchor" aria-label="anchor" href="#covariates-cv-cvset"></a>
</h3>
</div>
<div class="section level3">
<h3 id="simple-covariates">Simple covariates<a class="anchor" aria-label="anchor" href="#simple-covariates"></a>
</h3>
<p>For simulation purposes covariates (normally found in a dataset) need
to be defined. Covariates can be either constant or change with time.
The times values <em>must be the same scale as the system</em>. The
following defines the value for the covariate <code>RACE</code>:</p>
<pre><code>&lt;CV:RACE&gt;; times;  [0];     hours
&lt;CV:RACE&gt;; values; [1];     ethnicity</code></pre>
<p>Covariates can also change with time. In this case consider the
subject weight (<code>WGT</code>). It begins at <code>70</code> and
measurements are made at several time points.</p>
<pre><code>&lt;CV:WGT&gt;; times;  [ 0 1680 3360 5040 10080];     hours 
&lt;CV:WGT&gt;; values; [70   65   60   58    56];     kg     </code></pre>
<p>Next we can alter how the simulations will interpret these values by
setting the type of covariate. By default the weight will be linearly
interpolated (<code>type = linear</code>), however we can hold the
weight constant until the next measurement is encountered (last value
carried forward) by declaring the type as <code>step</code></p>
<pre><code>&lt;CVTYPE:WGT&gt; step</code></pre>
<p>Now if the model was parameterized for male and female subjects we
can define two parameter sets (as described above) to account for
this:</p>
<pre><code>&lt;PSET:default&gt;  Male   
&lt;PSET:female&gt;   Female          </code></pre>
<p>And the values for the covariate can be changed for the set
‘female’:</p>
<pre><code>&lt;CVSET:female:WGT&gt;; times;   [ 0 1680 3360 10080]
&lt;CVSET:female:WGT&gt;; values;  [60   55   52    50]</code></pre>
</div>
<div class="section level3">
<h3 id="complicated-covariates">Complicated covariates<a class="anchor" aria-label="anchor" href="#complicated-covariates"></a>
</h3>
<p>Detailed time course profiles can be created as well. For example, to
create a covariate profile that is zero from time 0-1 and at time 1 it
jumps to 8 and decreases at a rate of 1 per unit time until time 5 where
it stays at the value 4 until time 12. It might have a profile like the
following:</p>
<div class="float">
<img src="covariates.png" style="width:50.0%" alt="Time-varying covariate input profile"><div class="figcaption">Time-varying covariate input profile</div>
</div>
<pre><code># name        time/values  values                         units
&lt;CV:mycov&gt;  ; times;       [0 .999 1 5 12];  hours
&lt;CV:mycov&gt;  ; values;      [0 0    8 4 4 ];  --   
&lt;CVTYPE:mycov&gt; linear</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="model-outputs">Model outputs<a class="anchor" aria-label="anchor" href="#model-outputs"></a>
</h2>
<p>Outputs are defined here in terms of states, parameters, secondary
parameters, input rates, and covariates listed above. The format used
is:</p>
<pre><code>&lt;O&gt; name = expression</code></pre>
<p>For example:</p>
<pre><code>&lt;O&gt; A_obs = A
&lt;O&gt; Coverage = A/(KD + A)
&lt;O&gt; QC_CLtot = Cp*CL/Vp + Cp*Vmax/(Km+Cp)</code></pre>
<p>Outputs that begin with <code>QC</code>, like <code>QC_CLtot</code>
above, will not be displayed in the ShinyApp. This is intended to make
them available at the scripting level for quality control (QC)
purposes.</p>
</div>
<div class="section level2">
<h2 id="functions-and-operators">Functions and operators<a class="anchor" aria-label="anchor" href="#functions-and-operators"></a>
</h2>
<p>Most of the standard operators behave as expected (<code>+</code>,
<code>-</code>, <code>*</code>, &amp; <code>/</code>) because most
languages use these consistently. There are however certain operators
and functions that differ between languages. For example, consider the
power function
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>a</mi><mi>b</mi></msup><annotation encoding="application/x-tex">a^b</annotation></semantics></math>).
In FORTRAN this would be <code>a**b</code>, in Matlab it is
<code>a^b</code>, and in C it is <code>pow(a,b)</code>. Given the
objectives here (write once and create multiple formats), this can be
quite challenging. The solution used here is to convert language
specific functions and operators into generic functions. So the power
operator would be:</p>
<pre><code><span><span class="va">SIMINT_POWER</span><span class="op">[</span><span class="va">a</span><span class="op">]</span><span class="op">[</span><span class="va">b</span><span class="op">]</span></span></code></pre>
<p>This would then be converted to the appropriate output format
depending on the output target. The following generic functions can be
used:</p>
<table class="table">
<thead><tr class="header">
<th>Operator/Function</th>
<th>Example</th>
<th>Format</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>power</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>a</mi><mi>b</mi></msup><annotation encoding="application/x-tex">a^b</annotation></semantics></math></td>
<td><code>SIMINT_POWER[a][b]</code></td>
</tr>
<tr class="even">
<td>exponential</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>e</mi><mi>a</mi></msup><annotation encoding="application/x-tex">e^a</annotation></semantics></math></td>
<td><code>SIMINT_EXP[a]</code></td>
</tr>
<tr class="odd">
<td>log base 10</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(a)</annotation></semantics></math></td>
<td><code>SIMINT_LOG10[a]</code></td>
</tr>
<tr class="even">
<td>log base e</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>ln</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\ln(a)</annotation></semantics></math></td>
<td><code>SIMINT_LOGN[a]</code></td>
</tr>
<tr class="odd">
<td>less than</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>&lt;</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a &lt; b</annotation></semantics></math></td>
<td><code>SIMINT_LT[a][b]</code></td>
</tr>
<tr class="even">
<td>less than or equal</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>≤</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a \le b</annotation></semantics></math></td>
<td><code>SIMINT_LE[a][b]</code></td>
</tr>
<tr class="odd">
<td>greater than</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>&gt;</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a &gt; b</annotation></semantics></math></td>
<td><code>SIMINT_GT[a][b]</code></td>
</tr>
<tr class="even">
<td>greater than or equal</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>≥</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a \ge b</annotation></semantics></math></td>
<td><code>SIMINT_GE[a][b]</code></td>
</tr>
<tr class="odd">
<td>equal</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>=</mo><mo>=</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a == b</annotation></semantics></math></td>
<td><code>SIMINT_EQ[a][b]</code></td>
</tr>
<tr class="even">
<td>and</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>&amp;</mi><mi>b</mi></mrow><annotation encoding="application/x-tex">a \&amp; b</annotation></semantics></math></td>
<td><code>SIMINT_AND[a][b]</code></td>
</tr>
</tbody>
</table>
<div class="section level3">
<h3 id="current-simulation-time">Current simulation time<a class="anchor" aria-label="anchor" href="#current-simulation-time"></a>
</h3>
<p>For some systems you will want to access the simulation time. To do
this you can use the internal variable <code>SIMINT_TIME</code>.</p>
</div>
<div class="section level3">
<h3 id="modeling-quasi-equilibrium-of-target-mediated-drugs">Modeling quasi-equilibrium of target-mediated drugs<a class="anchor" aria-label="anchor" href="#modeling-quasi-equilibrium-of-target-mediated-drugs"></a>
</h3>
<p>The free amount of a drug <code>Cfree</code> which is binding to a
receptor with an affinity of <code>KD</code> given total values
<code>Ctot</code> and <code>Rtot</code> the following can be calculated
using the following equation:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mrow><mi>f</mi><mi>r</mi><mi>e</mi><mi>e</mi></mrow></msub><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mrow><mo stretchy="true" form="prefix">[</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>C</mi><mrow><mi>t</mi><mi>o</mi><mi>t</mi></mrow></msub><mo>−</mo><msub><mi>R</mi><mrow><mi>t</mi><mi>o</mi><mi>t</mi></mrow></msub><mo>−</mo><msub><mi>K</mi><mi>D</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msqrt><mrow><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>C</mi><mrow><mi>t</mi><mi>o</mi><mi>t</mi></mrow></msub><mo>−</mo><msub><mi>R</mi><mrow><mi>t</mi><mi>o</mi><mi>t</mi></mrow></msub><mo>−</mo><msub><mi>K</mi><mi>D</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup><mo>+</mo><mn>4</mn><msub><mi>K</mi><mi>D</mi></msub><msub><mi>C</mi><mrow><mi>t</mi><mi>o</mi><mi>t</mi></mrow></msub></mrow></msqrt><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
C_{free}=\frac{1}{2}
\left[
(C_{tot}-R_{tot}-K_D)
+ \sqrt{(C_{tot}-R_{tot}-K_D)^2 + 4K_DC_{tot}}
\right]
</annotation></semantics></math></p>
<p>This can be tedious, especially using the generic functions above. To
make this easier you can use the following generic function:</p>
<pre><code>&lt;Ad&gt; Cfree = SIMINT_QEQ[Ctot][Rtot][KD]</code></pre>
<p>To get <code>Rfree</code>, just switch the first two arguments:</p>
<pre><code>&lt;Ad&gt; Rfree = SIMINT_QEQ[Rtot][Ctot][KD]</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="timescales">Timescales<a class="anchor" aria-label="anchor" href="#timescales"></a>
</h2>
<p>Each system has default units in which it is constructed, and should
be indicated in the comments of the model. It can be useful (for
generating figures for example) to show simulations in different time
scales. Now this can be achieved by multiplying the time outputs by the
correct scaling factor. However this requires the end user to (1)
remember the original timescale and (2) correctly scale that value.</p>
<p>Now while this is not particularly challenging from a mathematical
perspective, it introduces a chance for error. It is possible, instead,
to specify time scale information using the <code>&lt;TS:?&gt;</code>
descriptor. If the system is coded in hours, the following will define
timescales for the default (hours), days, weeks and months:</p>
<pre><code>&lt;TS:hours&gt;  1.0
&lt;TS:days&gt;   1.0/24.0
&lt;TS:weeks&gt;  1.0/24.0/7.0
&lt;TS:months&gt; 1.0/24.0/7.0/4.0</code></pre>
<p>These are used both in the <strong>ShinyApp</strong> and at the
command line in <strong>Matlab</strong> and <strong>R</strong></p>
</div>
<div class="section level2">
<h2 id="mathematical-sets">Mathematical sets<a class="anchor" aria-label="anchor" href="#mathematical-sets"></a>
</h2>
<p>Consider the following systems:</p>
<p><strong>PBPK:</strong> Most of the organs in these systems are
mathematically identical, with only variations in the parameters.
However coding each of these organs or modifying an existing system (say
to incorporate the presences of a target in each organ) can become
tedious.</p>
<p><strong>Anti-drug antibody generation:</strong> If we consider ADAs
generated in response to therapeutic proteins, the response will consist
of a distribution of ADAs in terms of their concentration and a separate
distribution in terms of their affinity. Modeling this maturation
process and the interactions between the ADAs, the therapeutic protein,
and drug targets becomes unmanageable quickly.</p>
<p>The question is: How can we make difficult problems easy and
intractable problems possible? The solution implemented here allows the
system to be defined in terms of <strong>mathematical sets</strong></p>
<div class="section level3">
<h3 id="set-notation-set">Set notation <code>&lt;SET:?&gt;?</code><a class="anchor" aria-label="anchor" href="#set-notation-set"></a>
</h3>
<p>Consider the interactions occurring in an assay designed to detect
drug (<code>D</code>) present in serum. In this assay a biotinylated
target (<code>TB</code>) is used to pull down the drug and a labeled
target (<code>TL</code>) is the signaling molecule used. The assay will
provide a signal when a complex containing both <code>TB</code> and
<code>TL</code> are present (<code>TB:D:TL</code> or
<code>TL:D:TB</code>). Samples can contain soluble target as well
(<code>TS</code>) which can interfere with the assay. To model this
assay, the following interactions should be considered:</p>
<div class="float">
<img src="system-paper-mathematical_sets.png" style="width:80.0%" alt="Mathematical sets"><div class="figcaption">Mathematical sets</div>
</div>
<p>Several options are available to construct this system. The ODEs
could simply be typed out for every possible combination. It’s also
possible to use the equilibrium <code>&lt;=kon:koff=&gt;</code> for all
the interactions as well. However, there is another option that will
handle the enumeration more easily. First we define the two mathematical
sets <code>TSi</code> and <code>TSk</code>:</p>
<pre><code>&lt;SET:TSi&gt; TL; TB; TS
&lt;SET:TSk&gt; TL; TB; TS</code></pre>
<p>With these defined we can then use the curly brace notation
(<code><a href="https://rdrr.io/r/base/Paren.html" class="external-link">{ }</a></code>) with any of the descriptors used to construct a
system. For example, the initial conditions for each of the target
states are defined as parameters (<code>T0_TL</code>,
<code>T0_TS</code>, <code>T0_TB</code>) in the model. These have to be
identified as initial conditions using the <code>&lt;I&gt;</code>
notation, and can be done with a single statement. This line:</p>
<pre><code>&lt;I&gt; {TSi} = T0_{TSi} </code></pre>
<p>Expands to:</p>
<pre><code>&lt;I&gt; TL = T0_TL
&lt;I&gt; TB = T0_TB
&lt;I&gt; TS = T0_TS</code></pre>
<p>Similar to the initial condition, the equilibrium between the
monomeric drug and the different targets can be defined using a single
statement:</p>
<pre><code>D + {TSi} &lt;=kon:koff=&gt; D_{TSi}</code></pre>
<p>That uses only one of the sets (<code>TSi</code>) and will be
expanded for each element in that set. To account for the formation of
complexes that contain a drug molecule and two different target
molecules, the following statement is used:</p>
<pre><code>D_{TSi} + {TSk} &lt;=kon:koff=&gt; {TSk}_D_{TSi}</code></pre>
<p>This statement contains two different sets (<code>TSi</code> and
<code>TSk</code>). When multiple sets are encountered, every possible
combination is evaluated</p>
<div class="section level4">
<h4 id="aligning-sets">Aligning Sets<a class="anchor" aria-label="anchor" href="#aligning-sets"></a>
</h4>
<p>By default sets will interpreted by evaluating every possible
permutation as shown above. However, it may be desirable to pair or
align sets. Take for example the transit compartments implemented by
Lobo and Balthasar to delay the onset of drug effect on cancer cells
[LB]. The transit compartment are implemented using a series of
differential equations:</p>
<p><span class="math display">$$
  \frac{dK1}{dt} = (K-K1)\frac{1}{\tau} \\
  \frac{dK2}{dt} = (K1-K2)\frac{1}{\tau} \\
  \frac{dK3}{dt} = (K2-K3)\frac{1}{\tau} \\
  \frac{dK4}{dt} = (K3-K4)\frac{1}{\tau}
$$</span></p>
<p>It’s possible to code each of these individually, but it’s also
possible to define these using mathematical set notation. We see that in
the first equation K is paired or aligned with K1, and in the second
it’s K1 and K2, etc. So first we define two sets of equal length whose
elements are aligned:</p>
<pre><code>&lt;SET:TRIN&gt;    K; K1; K2; K3
&lt;SET:TROUT&gt;  K1; K2; K3; K4 </code></pre>
<p>Next we write the <code>&lt;ODE:?&gt;?</code> statement in terms of
these sets, but we use the <code>SIMINT_SET_ALIGN</code> function:</p>
<pre><code>SIMINT_SET_ALIGN[TRIN;TROUT][&lt;ODE:{TROUT}&gt; 1.0/tau*({TRIN}-{TROUT})]</code></pre>
<p>The first argument is the names of sets to align separated by a
semicolon <code>;</code> and the second argument is the system file
descriptor written in terms of these sets. This will be expanded
internally into:</p>
<pre><code>&lt;ODE:K1&gt; 1.0/tau*(K-K1)
&lt;ODE:K2&gt; 1.0/tau*(K1-K2)
&lt;ODE:K3&gt; 1.0/tau*(K2-K3)
&lt;ODE:K4&gt; 1.0/tau*(K3-K4)</code></pre>
</div>
<div class="section level4">
<h4 id="set-functions">Set Functions<a class="anchor" aria-label="anchor" href="#set-functions"></a>
</h4>
<p>It can be useful to perform operations over sets. To do this you can
use the following functions:</p>
<ul>
<li>
<code>SIMINT_SET_SUM</code> is the mathematical equivalent of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mo>∑</mo><mrow><mi>S</mi><mi>E</mi><mi>T</mi></mrow></msub><annotation encoding="application/x-tex">\sum_{SET}</annotation></semantics></math>
</li>
<li>
<code>SIMINT_SET_PRODUCT</code> is the mathematical equivalent of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mo>∏</mo><mrow><mi>S</mi><mi>E</mi><mi>T</mi></mrow></msub><annotation encoding="application/x-tex">\prod_{SET}</annotation></semantics></math>
</li>
</ul>
<p>These functions take two bracketed arguments. The first argument is
the set name and the second argument is the mathematical relationship to
be expanded. For example, consider a system that has been parameterized
for several species. The variable <code>EN_Mouse</code> is 1 if the
species is mouse and 0 otherwise. Similarly for <code>EN_Human</code>,
<code>EN_Monkey</code>, etc. We have also defined the body weights as
system parameters: <code>BW_Mouse</code> for the mouse,
<code>BW_Human</code> for human, etc. Now we want to assign
<code>BW</code> to the value of the currently selected species (where
<code>EN</code> for that species is 1). First we would define the
species parameter set:</p>
<pre><code>&lt;SET:SP&gt; Mouse; Rat; Monkey; Human</code></pre>
<p>Next we would define the secondary parameter <code>BW</code> by
summing the product of the Boolean species parameter and the body weight
for that species:</p>
<pre><code>&lt;As&gt; BW = SIMINT_SET_SUM[SP][EN_{SP}*BW_{SP}]</code></pre>
</div>
<div class="section level4">
<h4 id="set-evaluation">Set Evaluation<a class="anchor" aria-label="anchor" href="#set-evaluation"></a>
</h4>
<p>Sets are evaluated in the following order:</p>
<ul>
<li>First set functions (<code>SIMINT_SET_SUM</code> and
<code>SIMINT_SET_PRODUCT</code>) are evaluated.</li>
<li>Next aligned sets are applied (<code>SIMINT_SET_ALIGN</code>)</li>
<li>Lastly, remaining sets are evaluated for every permutation</li>
</ul>
</div>
</div>
</div>
<div class="section level2">
<h2 id="piecewise-continuous-functionsparameters-if">Piecewise-continuous functions/parameters
<code>&lt;IF:?:?&gt;</code><a class="anchor" aria-label="anchor" href="#piecewise-continuous-functionsparameters-if"></a>
</h2>
<p>To specify a conditional assignment use the statement:</p>
<pre><code>&lt;IF:name:COND&gt; boolean; value</code></pre>
<p>Here <code>name</code> is the name of the secondary parameter be
defined and <code>COND</code> indicates that we have a Boolean condition
that needs to be satisfied. The condition (<code>boolean</code>) can be
and, or, greater than, etc. relationships. The parameter will be
assigned to have the value when this Boolean relationship is true. These
conditions can be a function of different elements of the system
depending on whether or not name refers to a static or dynamic secondary
parameter:</p>
<ul>
<li>
<code>&lt;As&gt;</code> function of system parameters, previously
defined static secondary parameters and covariates that do not change
for a given subject.</li>
<li>
<code>&lt;Ad&gt;</code> function of system parameters, static
secondary parameters, states, previously defined dynamic secondary
parameters and covariates.</li>
</ul>
<p>It is important to include a default <code>ELSE</code> condition:</p>
<pre><code>&lt;IF:name:ELSE&gt; value</code></pre>
<div class="section level3">
<h3 id="constructing-a-piece-wise-continuous-functionparameter">Constructing a piece-wise continuous function/parameter<a class="anchor" aria-label="anchor" href="#constructing-a-piece-wise-continuous-functionparameter"></a>
</h3>
<p>To see an example use the following command (use
<code><a href="../reference/system_new.html">?system_new</a></code> to see a list of the available system file
examples):</p>
<p><code>system_new(system_file="pwc", file_name="system-pwc.txt")</code></p>
<p>In this example we specify fast (<code>kelf</code>) and slow
(<code>kels</code>) rates of elimination. We want to have the fast rate
be active when the drug concentration is above <code>Cth</code> and the
time is below <code>Tf</code>. The system parameters would look
like:</p>
<pre><code>&lt;P&gt; kelf   1.0  eps inf   1/time   yes System
&lt;P&gt; kels   0.01 eps inf   1/time   yes System
&lt;P&gt; Cth   10    eps inf   conc     yes System
&lt;P&gt; Tf    10    eps inf   time     yes System</code></pre>
<p>Now we need to define the rate of elimination such that the
constraints above are followed. First we define <code>kel</code> as a
dynamic secondary parameter with a value of 0.0. Then we define the
different conditions and relevant values:</p>
<pre><code>&lt;Ad &gt; kel = 0.0
&lt;IF:kel:COND&gt; SIMINT_AND[SIMINT_LT[SIMINT_TIME][Tf]][ SIMINT_GT[Cp][Cth]]; kelf
&lt;IF:kel:ELSE&gt; kels</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="controlling-indices">Controlling indices<a class="anchor" aria-label="anchor" href="#controlling-indices"></a>
</h2>
<p>By default, the build script will construct odes, parameter sets,
etc. automatically. This means that the order of states/compartments are
going to be arbitrary. Sometimes it is necessary to specify the order of
your states or outputs. For example when using NONMEM the order in the
control stream must correlate with the values in the dataset. To specify
that a state <code>Cp</code> should be compartment <code>3</code>, the
following should be used:</p>
<pre><code>&lt;INDEX:STATE:Cp&gt;  3</code></pre>
<p>The general notation for an output or state <code>name</code>
assigned to a <code>number</code> is:</p>
<pre><code>&lt;INDEX:STATE:name&gt;  number
&lt;INDEX:OUTPUT:name&gt; number</code></pre>
<div class="section level3">
<h3 id="output-error-oe">Output error <code>&lt;OE:?&gt; ?</code><a class="anchor" aria-label="anchor" href="#output-error-oe"></a>
</h3>
<p>This links parameters defined using <code>&lt;VP:?&gt;</code> to
specific outputs defined using <code>&lt;O&gt;</code>. You can define
either <code>add</code> for additive and/or <code>prop</code> for
proportional error.</p>
<pre><code>&lt;VP&gt; prop_err   0.1            eps    inf      --     yes      Variance
&lt;VP&gt; add_err    0.1            eps    inf      conc  yes      Variance
&lt;O&gt; Cp = expression
&lt;OE:Cp&gt; add=add_error; prop=prop_error</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="concentrations-vs-amounts">Concentrations vs amounts<a class="anchor" aria-label="anchor" href="#concentrations-vs-amounts"></a>
</h2>
<p>It’s more convenient to model systems in terms of concentrations.
However some software does not allow scaling of inputs. And when inputs
are provided in mass units, you need your differential equation to also
be in mass units. You can use the <code>&lt;AMTIFY&gt;</code> descriptor
in your <code>system.txt</code> to tell ubiquity to generate perform
this conversion on the differential equations.</p>
<p>For example, if you defined the state <code>Cc</code> but want it to
be <code>Ac</code> within the nlmixr2 model target. These are related by
<code>Cc = Ac/Vc</code> and <code>Vc</code> is a parameter the following
would be used:</p>
<pre><code>&lt;AMTIFY&gt; Cc; Ac; Vc</code></pre>
</div>
<div class="section level2">
<h2 id="options">Options<a class="anchor" aria-label="anchor" href="#options"></a>
</h2>
<p>Several options can be specified using the <code>&lt;OPT:?</code>
delimiter. If you’ve defined the <code>days</code> timescale using
<code>&lt;TS:?&gt;?</code> this can be used as the timescale for
plotting in the ShinyApp by using:</p>
<pre><code>&lt;OPT:TS&gt;  days</code></pre>
<p>To define the default output times for the ShinyApp and simulation
scripts use the following:</p>
<pre><code>&lt;OPT:output_times&gt; SIMINT_SEQ[0][100][1]</code></pre>
</div>
<div class="section level2">
<h2 id="example-system-files">Example system files<a class="anchor" aria-label="anchor" href="#example-system-files"></a>
</h2>
<p>These example system files can be found in the examples directory of
the stand-alone analysis template (<a href="https://ubiquity-pkpd.s3-us-west-1.amazonaws.com/files/ubiquity_analysis_development.zip" class="external-link">ubiquity_template.zip</a>).
Most can also be loaded form the R package (see the help for
<code><a href="../reference/system_new.html">?system_new</a></code>).</p>
<ul>
<li>
<code>system-adapt.txt</code> - Parent/metabolite structural model
taken from the ADAPT5 Users Manual [ADAPT]. This system is used in the
estimation examples of the ubiquity workshop.</li>
<li>
<code>system-glp_study.txt</code> - PK model parameterized for
humans and NHPs, used as an example for GLP tox study design.</li>
<li>
<code>system-mab_pk.txt</code> - Linear model of mAb PK for humans
taken from [DM]. This model is used in the simulation examples of the
ubiquity workshop.</li>
<li>
<code>system-one_cmt_cl.txt</code> - One compartment model
parameterized in terms of clearances and volumes.</li>
<li>
<code>system-one_cmt_micro.txt</code> - One compartment model
parameterized for micro constants (rates).</li>
<li>
<code>system-pbpk.txt</code> - Implementation of large molecule PBPK
model by Shah and Betts [SB]. This model provides good examples of how
to use mathematical set notation.</li>
<li>
<code>system-pbpk_template.txt</code> - Template containing the
species parameter from [SB]. This can be used to construct systems
parameterized for multiple species.</li>
<li>
<code>system-pwc.txt</code> - Example of how to construct piece-wise
secondary parameters (i.e. using if/then/else statements).</li>
<li>
<code>system-sets.txt</code> - Example of how to parameterized
systems with multiple parameter sets.</li>
<li>
<code>system-tmdd.txt</code> - Example of how to code a TMDD model
using either ODEs or process descriptors.</li>
<li>
<code>system-tumor.txt</code> - Implementation of transit effect
model in cancer cell inhibition from [LB]. This demonstrates how to use
aligned mathematical sets.</li>
<li>
<code>system-two_cmt_cl.txt</code> - Two compartment model
parameterized in terms of clearances and volumes</li>
<li>
<code>system-two_cmt_micro.txt</code> - Two compartment model
parameterized in terms of micro constants (rates)</li>
</ul>
</div>
<div class="section level2">
<h2 id="templates">Templates<a class="anchor" aria-label="anchor" href="#templates"></a>
</h2>
<p>When the system is built, multiple files are generated in the
temporary directory (<code>transient</code>) to support different
software. In the R package you can access these and other templates
programatically (see the help for <code><a href="../reference/system_fetch_template.html">?system_fetch_template</a></code>).
This is a list of the supporting software and what is generated.</p>
<div class="section level3">
<h3 id="r-workflow">R workflow<a class="anchor" aria-label="anchor" href="#r-workflow"></a>
</h3>
<ul>
<li>
<code>auto_simulation_driver.R</code>: R-Script with named with
placeholders used to run simulations.</li>
<li>
<code>auto_analysis_estimation.R</code>: R-Script with named with
placeholders used to perform naive-pooled parameter estimation.</li>
</ul>
</div>
<div class="section level3">
<h3 id="matlab-workflow">Matlab workflow<a class="anchor" aria-label="anchor" href="#matlab-workflow"></a>
</h3>
<ul>
<li>
<code>auto_simulation_driver.m</code>: M-file with named with
placeholders used to run simulations.</li>
<li>
<code>auto_analysis_estimation.m</code>: M-file with named with
placeholders used to perform naive-pooled parameter estimation.</li>
</ul>
</div>
<div class="section level3">
<h3 id="other-software-targets">Other Software Targets<a class="anchor" aria-label="anchor" href="#other-software-targets"></a>
</h3>
<ul>
<li><p><code>target_adapt_5.for</code> and
<code>target_adapt_5-PSET.prm</code>: The system defined for Adapt
Fortran and a parameter (<code>prm</code>) file for each parameter set
<code>PSET</code>.</p></li>
<li><p><code>target_berkely_madonna-PSET.txt</code>: This is a text file
containing the system for the parameter set <code>PSET</code> to run in
Berkeley Madonna.</p></li>
<li><p><code>target_mrgsolve-PSET.cpp</code>: This is a C++ file
containing the system for the parameter set <code>PSET</code> to run
using the in <code>mrgsolve</code> package in R.</p></li>
<li><p><code>target_nlmixr-PSET.R</code>: This R script defines the
system for analysis in <code>nlmixr2</code> for the parameter set
<code>PSET</code>. <em>Note: The nlmixr2 target can be used to create
input model files for both NONMEM and Monolix</em></p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li>[ADAPT] <a href="https://bmsr.usc.edu/files/2013/02/ADAPT5-User-Guide.pdf" class="external-link">Adapt 5
Users Guide</a>
</li>
<li>[DM] <a href="https://doi.org/10.2165/11535960-000000000-00000" class="external-link">Dirks &amp;
Meibohm Clin. PK (2010) Oct 1;49(10):633-59</a>
</li>
<li>[LB] <a href="https://doi.org/10.1208/ps040442" class="external-link">Lobo, E.D. &amp;
Balthasar, J.P. AAPS J (2002) 4, 212-222</a>
</li>
<li>[MK] <a href="https://doi.org/10.1007/s11095-005-6650-0" class="external-link">Mager, D.E.
&amp; Krzyzanski, W. Pharm Res (2005) 22: 1589.</a>
</li>
<li>[SB] <a href="https://doi.org/10.1007/s10928-011-9232-2" class="external-link">Shah, D.K.
&amp; Betts, A.M. JPKPD (2012) 39 (1), 67-86</a>
</li>
<li>[VR] <a href="https://doi.org/10.1002/eji.1830180221" class="external-link">Vieira &amp;
Rajewsky Eur J Immunol. (1988) Feb;18(2):313-6</a>
</li>
</ul>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by John Harrold.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
